# LLM連携仕様

## 1. 概要

本ドキュメントは、Labシステムにおける大規模言語モデル（LLM）の連携に関する仕様を定義します。主な目的は、キャラクターの感情や思考の描写、ゲームログの解析、およびセッションリザルト（特に「遺言」や「最終思考パターン」）の生成を通じて、プレイヤーに深い没入感とキャラクターへの愛着を提供することです。

## 2. LLMの役割

### 2.1. 【最重要】リザルト（遺言/最終思考パターン）生成
-   **目的**: セッションやキャラクターの生涯（あるいは特定の期間）を通じて得られた体験、感情、選択を凝縮し、キャラクター自身の言葉や視点による物語的なテキスト、または分析的な思考パターンを生成します。
-   **トリガー**: キャラクターロスト時（死亡事象ログ生成時）、セッション終了時、プレイヤーの特定の行動やリクエスト時など。
-   **入力**:
    -   対象キャラクターの全データ（[character_data.md](./character_data.md) 参照）。特に `geneticInfo`, `traits`, `relationships`, `personalLog` など。
    -   関連する構造化ログ（[log_schema.md](./log_schema.md) 参照）。全ログ、または重要度や時間経過に応じてサンプリング/要約されたログ。
    -   （もしあれば）プレイヤーからの特別な指示やコンテキスト（例：「特定のNPCとの関係性を強調してほしい」）。
-   **出力**: テキスト形式のリザルト。
    -   **遺言形式**: キャラクターの一人称視点での物語的な回想、感情の吐露、未練、希望など。
    -   **最終思考パターン形式**: Arbiterが分析するような、より客観的または断片的な思考の記録。死亡事象ログの「残留思念/最終思考」部分に利用。
-   **考慮事項**:
    -   膨大なログから重要な情報を抽出・要約する手法（記憶メカニズム）。
    -   キャラクターの性格、知性、口調（特性や過去の発言ログから推測）の一貫性。
    -   プレイヤー設定による出力の詳細度や感情表現の調整機能。

### 2.2. キャラクター感情・思考のリアルタイム描写 (オプション)
-   **目的**: ゲームイベントやプレイヤーの行動に応じて、キャラクターの現在の感情や思考をテキストで描写し、UIやログに表示します。
-   **トリガー**: 特定のゲームイベント発生時、一定時間経過、プレイヤーのリクエスト。
-   **入力**: 直近の構造化ログ、キャラクターデータ（特に感情関連特性や現在のリソース状態）、現在の状況（周囲の環境、他キャラクターの存在など）。
-   **出力**: 短いテキスト（例: 「対象は強い恐怖を感じているようだ。」、「実験の成功に静かな満足を覚えている。」）。

### 2.3. NPC対話生成 (オプション)
-   **目的**: 特定の状況下で、NPCのセリフや行動のバリエーションをLLMが生成します。
-   **入力**: NPCのキャラクターデータ（性格、役割、知識、他キャラクターとの関係性など）、現在のゲーム状況、対話履歴。
-   **出力**: NPCのセリフ（テキスト）、場合によっては行動の提案。

## 3. リザルト（遺言/最終思考パターン）の詳細仕様

-   **基本構成要素**:
    -   キャラクター名、識別ID、セッション期間または生存期間。
    -   導入（例: 遺言形式なら「薄れゆく意識の中、思い出すのは…」、最終思考パターンなら「警告：生命維持限界。思考パターン記録開始…」）。
    -   主要な体験やターニングポイントの回想（ログ解析に基づく）。
    -   特に印象的だった出来事、重要な選択、強く影響を受けた他者との関係性。
    -   最終的な感情の複合（喜び、悲しみ、怒り、恐怖、後悔、達成感など）や、到達した（あるいは到達できなかった）境地、未練、希望の断片。
    -   結びの言葉または思考の途絶。
-   **強調すべき要素**:
    -   キャラクター自身の感情、思考、動機、そしてその変化。
    -   プレイヤー（外部観測者）から与えられた影響（命令、アイテム、会話、共同体験）。
    -   Labの過酷な環境やシステム内での葛藤と選択。
-   **カスタマイズ要素（プレイヤー向けオプション）**:
    -   出力形式の選択（一人称の物語風、三人称の客観記録風、詩的な断片など）。
    -   詳細度レベルの調整。
    -   特定の記憶や人物に焦点を当てるかどうかの選択。

## 4. ログ解析と記憶メカニズム

-   **課題**: 膨大なログデータから、LLMが意味のある情報を効率的に抽出し、利用可能にする。
-   **アプローチ案**:
    -   **構造化ログの活用**: [log_schema.md](./log_schema.md) に基づくログを解析。
    -   **重要度マーキング**: `importance` フィールドや特定の `eventType` （例: `GoalUpdated`, `EmotionStateUpdated`, `EntityStatusChange`でHPが0になった場合など）を重視。
    -   **短期記憶バッファ**: 直近の数十〜数百のログエントリを保持。
    -   **長期記憶の要約・ベクトル化**: 定期的に（例: サイクル終了時、重要イベント後）LLMにログの要約を生成させ、キャラクターの「記憶スナップショット」として保存。これらをベクトル化し、類似性検索を可能にする。
    -   **感情トリガー**: `EmotionStateUpdated` ログをフックに、関連する過去の出来事を想起しやすくする。
    -   **階層的サマリー**: 短期記憶→中期的なエピソード記憶→生涯を通じた重要記憶、といった階層で情報を整理・要約。

## 5. LLMモデルとAPI連携

-   **候補モデル**: 最新の高機能LLM（具体的なモデル名はプロジェクト進行に応じて選定）。
-   **API連携**: 非同期APIコールを基本とし、システムの応答性を損なわないように設計。
-   **コスト管理**: トークン数制限、APIコール頻度の最適化（リクエストのマージ、キャッシュ戦略など）。
-   **プロンプトエンジニアリング**: LLMにキャラクターのペルソナ、状況、目的を正確に伝え、望ましい形式と内容の出力を得るためのプロンプト設計が極めて重要。キャラクターシートの関連情報、重要なログの抜粋、現在のコンテキストなどをプロンプトに含める。

## 6. セキュリティと倫理

-   LLMへの入力データ（特に個人ログやプレイヤー間のチャット）のプライバシー保護。
-   LLMの出力が不適切（差別的、暴力的、あるいはゲームの世界観を著しく損なうなど）な内容にならないためのフィルタリングやガイドライン設定。
-   LLMのハルシネーション（事実に基づかない情報の生成）への対策と、生成された内容が「キャラクターの主観的解釈」であることを明示するなどの工夫。 